conf = crashd_config(workdir='./workdir')
ssh_conf = ssh_config(username="capv", private_key_path="./privatekey")
kube_conf = kube_config(path='./config')

#list out management and workload cluster nodes
wc_provider=capv_provider(
    ssh_config=ssh_conf,
    mgmt_kube_config=kube_conf
)
wc_provider_cp=capv_provider(
    ssh_config=ssh_conf,
    mgmt_kube_config=kube_conf,
    labels=["node-role.kubernetes.io/control-plane="]
)

nodes = resources(provider=wc_provider)
cp_nodes = resources(provider=wc_provider_cp)
capture(cmd="timeout 60s vmstat 5", resources=cp_nodes)

cp_metrics = [
  "etcd_disk_backend_commit_duration_seconds",
  "etcd_network_peer_round_trip_time_seconds",
  "etcd_debugging_disk_backend_commit_rebalance_duration_seconds",
  "etcd_debugging_disk_backend_commit_spill_duration_seconds",
  "etcd_debugging_disk_backend_commit_write_duration_seconds",
  "etcd_debugging_lease_ttl_total",
  "etcd_debugging_mvcc_db_compaction_pause_duration_milliseconds",
  "etcd_debugging_mvcc_db_compaction_total_duration_milliseconds",
  "etcd_debugging_mvcc_index_compaction_pause_duration_milliseconds",
  "etcd_debugging_snap_save_marshalling_duration_seconds",
  "etcd_debugging_snap_save_total_duration_seconds",
  "etcd_disk_backend_defrag_duration_seconds",
  "etcd_disk_backend_snapshot_duration_seconds",
  "etcd_disk_wal_fsync_duration_seconds",
  "etcd_mvcc_hash_duration_seconds",
  "etcd_mvcc_hash_rev_duration_seconds",
  "etcd_snap_db_fsync_duration_seconds",
  "etcd_snap_db_save_total_duration_seconds",
  "etcd_snap_fsync_duration_seconds",
]
plot_metric(metrics=cp_metrics, resources=cp_nodes)


#add code to collect pod info from cluster
set_defaults(kube_config(capi_provider = wc_provider))

pod_ns=["default", "kube-system"]

kube_capture(what="logs", namespaces=pod_ns)
kube_capture(what="objects", kinds=["pods", "services"], namespaces=pod_ns)
kube_capture(what="objects", kinds=["deployments", "replicasets"], groups=["apps"], namespaces=pod_ns)

# archive(output_file="diagnostics.tar.gz", source_paths=[conf.workdir])